# Modern Configuration for KFe3J (KFe3(OH)6(SO4)2)
# Fully declarative, replacing spin_model.py

# 1. Structure
# 1. Structure
crystal_structure:
  dimensionality: 2 # Important for neighbor generation order
  lattice_parameters:
    a: 7.33
    b: 7.33
    c: 17.1374
    alpha: 90
    beta: 90
    gamma: 120
  atoms_uc: # expressed in fractional coordinates
    - label: Fe1
      pos: [0.0, 0.0, 0.0]
      spin_S: 2.5
    - label: Fe2
      pos: [0.5, 0.0, 0.0]
      spin_S: 2.5
    - label: Fe3
      pos: [0.0, 0.5, 0.0]
      spin_S: 2.5
  magnetic_elements: ["Fe"]

# 2. Parameters
parameters:
  S: 2.5
  J1: 3.23
  J2: 0.11
  Dy: 0.218 # D vector in-plane
  Dz: -0.195 # D vector out-of-plane
  H_dir: [0.0, 0.0, 1.0] # Field Direction
  H_mag: 0.0 # Field Magnitude

# 3. Interactions
interactions:
  # Heisenberg Exchange
  - type: heisenberg
    distance: 3.665 # 0.5 * 7.33
    value: "J1"
  - type: heisenberg
    distance: 6.348 # 0.866 * 7.33
    value: "J2"
    
  # DM Interactions (Manual Specification due to Kagome symmetry)
  
  # Atom 0 (r1) Connections
  - type: dm_manual
    atom_i: 0
    atom_j: 1 # Intra-cell
    offset_j: [0, 0, 0]
    value: ["0", "-Dy", "-Dz"] # -DMvec2_new: [0, -Dy, -Dz]
    
  - type: dm_manual
    atom_i: 0
    atom_j: 2 # Intra-cell
    offset_j: [0, 0, 0]
    value: ["-sqrt(3)/2*Dy", "-Dy/2", "Dz"] # -DMvec1_new: [-sqrt(3)/2*Dy, -Dy/2, Dz]
    
  - type: dm_manual
    atom_i: 0
    atom_j: 1 # Neighbor (-1, 0)
    offset_j: [-1, 0, 0]
    value: ["0", "-Dy", "-Dz"] # -DMvec2_new
    
  - type: dm_manual
    atom_i: 0
    atom_j: 2 # Neighbor (0, -1)
    offset_j: [0, -1, 0]
    value: ["-sqrt(3)/2*Dy", "-Dy/2", "Dz"] # -DMvec1_new
    
  # Atom 1 (r2) Connections
  - type: dm_manual
    atom_i: 1
    atom_j: 0 # Intra-cell
    offset_j: [0, 0, 0]
    value: ["0", "Dy", "Dz"] # DMvec2_new: [0, Dy, Dz]
    
  - type: dm_manual
    atom_i: 1
    atom_j: 2 # Neighbor (0, -1)
    offset_j: [0, -1, 0]
    value: ["-sqrt(3)/2*Dy", "Dy/2", "-Dz"] # DMvec3_new: [-sqrt(3)/2*Dy, Dy/2, -Dz]
    
  - type: dm_manual
    atom_i: 1
    atom_j: 0 # Neighbor (1, 0)
    offset_j: [1, 0, 0]
    value: ["0", "Dy", "Dz"] # DMvec2_new
    
  - type: dm_manual
    atom_i: 1
    atom_j: 2 # Neighbor (1, 0)
    offset_j: [1, 0, 0]
    value: ["-sqrt(3)/2*Dy", "Dy/2", "-Dz"] # DMvec3_new
    
  # Atom 2 (r3) Connections
  - type: dm_manual
    atom_i: 2
    atom_j: 0 # Intra-cell
    offset_j: [0, 0, 0]
    value: ["sqrt(3)/2*Dy", "Dy/2", "-Dz"] # DMvec1_new: [sqrt(3)/2*Dy, Dy/2, -Dz]
    
  - type: dm_manual
    atom_i: 2
    atom_j: 1 # Neighbor (-1, 0)
    offset_j: [-1, 0, 0]
    value: ["sqrt(3)/2*Dy", "-Dy/2", "Dz"] # -DMvec3_new: [sqrt(3)/2*Dy, -Dy/2, Dz]
    
  - type: dm_manual
    atom_i: 2
    atom_j: 0 # Neighbor (0, 1)
    offset_j: [0, 1, 0]
    value: ["sqrt(3)/2*Dy", "Dy/2", "-Dz"] # DMvec1_new
    
  - type: dm_manual
    atom_i: 2
    atom_j: 1 # Neighbor (0, 1)
    offset_j: [0, 1, 0]
    value: ["sqrt(3)/2*Dy", "-Dy/2", "Dz"] # -DMvec3_new

# 5. Calculation Settings
calculation:
  cache_mode: 'auto' # Use 'auto' to read from cache if available, or generate if missing
  cache_file_base: "KFe3J_modern_cache"

# 6. Q-Path
q_path:
  G: [0.0, 0.0, 0.0]
  K: [0.333333, 0.333333, 0.0]
  M: [0.5, 0.0, 0.0]
  path: ["G", "K", "M", "G"]
  points_per_segment: 200

# 7. Output
output:
  disp_data_filename: "../../cache/data/KFe3J_modern_disp_data.npz"
  sqw_data_filename: "../../cache/data/KFe3J_modern_sqw_data.npz"

# 8. Plotting
plotting:
  save_plot: true
  disp_plot_filename: "../plots/KFe3J_modern_disp.png"
  sqw_plot_filename: "../plots/KFe3J_modern_sqw.png"
  energy_limits_disp: [0, 20]
  energy_limits_sqw: [0, 20]
  sqw_title: "S(Q,w) - Modern Config"
  disp_title: "Dispersion - Modern Config"
  show_plot: false  
  plot_structure: false

# 7. Tasks
tasks:
    # run_dispersion: true
    # run_sqw: false
    # calculate_dispersion_new: true
  run_minimization: true
  run_dispersion: true
  run_sqw_map: true
  calculate_dispersion_new: true
  calculate_sqw_map_new: true
  plot_dispersion: true 
  plot_sqw_map: true

# 9. Minimization Settings
minimization:
  method: "L-BFGS-B"
  maxiter: 5000

# 10. Magnetic Structure (New Input Method)
magnetic_structure:
  type: pattern
  pattern_type: "antiferromagnetic" # Use generic AFM type for cyclic directions
  directions:
    - [-1.0, 0.0, 0.0]            # Atom 0 (180 deg)
    - [0.5, -0.86602540378, 0.0]  # Atom 1 (300 deg)
    - [0.5, 0.86602540378, 0.0]   # Atom 2 (60 deg)
