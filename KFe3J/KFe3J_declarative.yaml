
# KFe3(OH)6(SO4)2 - Jarosite structure
# Declarative Config with Explicit Primitive Structure

crystal_structure:
  # Explicitly define the 3-atom primitive cell to match spin_model.py geometry
  # Scaling: J1 distance in spin_model.py is 0.5 units. Real J1 is 3.665 A.
  # So a_script = 1 unit -> 2 * 3.665 = 7.33 A.
  dimensionality: 2 # Restrict neighbor search to 2D plane (a,b) to match manual script optimization
  lattice_vectors:
    - [0.866025403784439, -0.5, 0.0]  # a_vec = [sqrt(3)/2, -0.5, 0]
    - [0.0, 1.0, 0.0]         # b_vec = [0, 1, 0]
    - [0.0, 0.0, 1.0]         # c_vec

  atom_positions:
    - [0.0, 0.0, 0.0]          # Atom 0
    - [0.433012701892219, -0.25, 0.0]   # Atom 1: [sqrt(3)/4, -0.25, 0]
    - [0.0, 0.5, 0.0]          # Atom 2: [0, 0.5, 0]
    
  magnetic_elements: ["Fe"] # Not used for manual definition but good for clarity

# Define Parameter Order for Mapping
parameters: ["J1", "J2", "Dy", "Dz", "H"]

model_params:
  S: 2.5
  J1: 3.23
  J2: 0.11
  Dy: 0.2
  Dz: 0.2
  H: 0.0

# Coordinate Transformations to match Ground State
transformations:
  variables:
    # Canting angle variables from spin_model.py
    # Z = J2 - sp.sqrt(3) / 3 * Dz
    Z: "J2 - sqrt(3)/3 * Dz"
    # Argument for arcsin(x)
    # x = 2 / (3 * J1) * (-sqrt(3) * Dy) / (1 + Z / J1)
    x_arg: "(2 * (-sqrt(3) * Dy)) / (3 * J1 * (1 + Z / J1))"
    
    # cos(theta) = sqrt(1 - x^2)
    cos_theta: "sqrt(1 - x_arg**2)"
    
    # Half-angle formulas for ca = theta/2
    # sin(ca) = sqrt((1 - cos(theta))/2)
    sin_ca: "sqrt((1 - cos_theta)/2)"
    # cos(ca) = sqrt((1 + cos(theta))/2)
    cos_ca: "sqrt((1 + cos_theta)/2)"

    # Base Rotation Matrix for Canting (mp_rot from spin_model.py)
    # [[cos(ca), 0, -sin(ca)], [0, 1, 0], [sin(ca), 0, cos(ca)]]
    M_cant: "Matrix([[cos_ca, 0, -sin_ca], [0, 1, 0], [sin_ca, 0, cos_ca]])"
    
  atom_frames:
    # Chirality angles: [-pi/3, pi, pi/3]
    # Atom 0: alpha = -pi/3
    - atom: 0
      rotation: "Matrix([[0, sin(-pi/3), cos(-pi/3)], [0, -cos(-pi/3), sin(-pi/3)], [1, 0, 0]]) * M_cant"

    # Atom 1: alpha = pi
    - atom: 1
      rotation: "Matrix([[0, sin(pi), cos(pi)], [0, -cos(pi), sin(pi)], [1, 0, 0]]) * M_cant"
      
    # Atom 2: alpha = pi/3
    - atom: 2
      rotation: "Matrix([[0, sin(pi/3), cos(pi/3)], [0, -cos(pi/3), sin(pi/3)], [1, 0, 0]]) * M_cant"

interactions:
  - type: heisenberg
    distance: 0.5 # J1
    value: "J1"     
    
  - type: heisenberg
    distance: 0.866025403784439 # J2 (sqrt(3)/2)
    value: "J2"     

  # DM Interactions (Manual)
  # i=0 (Fe1)
  - type: dm_manual
    atom_i: 0
    atom_j: 1
    offset_j: [0, 0, 0]
    value: ["-0.5*Dy", "-sqrt(3)/2*Dy", "-Dz"] 

  - type: dm_manual
    atom_i: 0
    atom_j: 2
    offset_j: [0, 0, 0]
    value: ["-Dy", "0", "Dz"] 
    
  - type: dm_manual
    atom_i: 0
    atom_j: 1
    offset_j: [-1, 0, 0]
    value: ["-0.5*Dy", "-sqrt(3)/2*Dy", "-Dz"] 

  - type: dm_manual
    atom_i: 0
    atom_j: 2
    offset_j: [0, -1, 0]
    value: ["-Dy", "0", "Dz"] 

  # i=1 (Fe2)
  - type: dm_manual
    atom_i: 1
    atom_j: 0
    offset_j: [0, 0, 0]
    value: ["0.5*Dy", "sqrt(3)/2*Dy", "Dz"] 
    
  - type: dm_manual
    atom_i: 1
    atom_j: 2
    offset_j: [0, -1, 0]
    value: ["-0.5*Dy", "sqrt(3)/2*Dy", "-Dz"] 
    
  - type: dm_manual
    atom_i: 1
    atom_j: 0
    offset_j: [1, 0, 0]
    value: ["0.5*Dy", "sqrt(3)/2*Dy", "Dz"] 

  - type: dm_manual
    atom_i: 1
    atom_j: 2
    offset_j: [1, 0, 0]
    value: ["-0.5*Dy", "sqrt(3)/2*Dy", "-Dz"] 
    
  # i=2 (Fe3)
  - type: dm_manual
    atom_i: 2
    atom_j: 0
    offset_j: [0, 0, 0]
    value: ["Dy", "0", "-Dz"] 

  - type: dm_manual
    atom_i: 2
    atom_j: 1
    offset_j: [-1, 0, 0]
    value: ["0.5*Dy", "-sqrt(3)/2*Dy", "Dz"] 

  - type: dm_manual
    atom_i: 2
    atom_j: 0
    offset_j: [0, 1, 0]
    value: ["Dy", "0", "-Dz"] 
    
  - type: dm_manual
    atom_i: 2
    atom_j: 1
    offset_j: [0, 1, 0]
    value: ["0.5*Dy", "-sqrt(3)/2*Dy", "Dz"] 


calculation:
  # Cache settings
  # Cache settings
  cache_file_base: "KFe3J_decl_final_cache" # Final verified cache
  cache_mode: "w"  # 'r' to read, 'w' to write/overwrite

q_path:
  Gamma: [0, 0, 0]
  M: [0.5, 0, 0] 
  K: [0.33333333, 0.33333333, 0] 
  points_per_segment: 50 
  path: ["Gamma", "M", "K", "Gamma"] 

output:
  disp_data_filename: "KFe3J_decl_prim_disp_data.npz" 
  sqw_data_filename: "KFe3J_decl_prim_sqw_data.npz" 

plotting: 
  save_plot: true
  disp_plot_filename: "KFe3J_decl_prim_disp_plot.png" 
  combined_plot_filename: "KFe3J_decl_prim_combined_plot.png" 
  sqw_plot_filename: "KFe3J_decl_prim_sqw_plot.png"   
  energy_limits_disp: [0, 20] 
  energy_limits_sqw: [0, 20]  
  disp_title: "KFe3J (Declarative Primitive) Spin Wave Dispersion"
  sqw_title: "KFe3J (Declarative Primitive) S(Q,w)"
  show_plot: false
  adjust_height_to_screen: true  
  screen_height_fraction: 0.85   

tasks:
  run_dispersion: true             
  calculate_dispersion_new: true   
  plot_dispersion: true            

  run_sqw_map: true                
  calculate_sqw_map_new: true      
  plot_sqw_map: true               
